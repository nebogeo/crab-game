;; -*- mode: scheme; -*-
; ------------------------------------------------
;; Copyright (C) 2016 FoAM Kernow
;;
;; This program is free software: you can redistribute it and/or modify
;; it under the terms of the GNU Affero General Public License as
;; published by the Free Software Foundation, either version 3 of the
;; License, or (at your option) any later version.
;;
;; This program is distributed in the hope that it will be useful,
;; but WITHOUT ANY WARRANTY; without even the implied warranty of
;; MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;; GNU Affero General Public License for more details.
;;
;; You should have received a copy of the GNU Affero General Public License
;; along with this program.  If not, see <http://www.gnu.org/licenses/>.

(load "scm/maths.jscm")
(load "scm/random.jscm")
(load "scm/nightjar.jscm")

(define game-time-allowed 10)
(define num-bgs-per-habitat 6) ;; 2 for demo
(define num-examples (* num-bgs-per-habitat 3))
(define num-crabs-per-habitat (/ num-bgs-per-habitat 3))

(define empty-button-width 300)
(define empty-button-height 200)


(define mudflat-filenames
   (list
"helford/7397_vis_helford.mspec_b1.jpg"
"helford/6404_vis_helford.mspec_b1.jpg"
"helford/6391_vis_helford.mspec_b1.jpg"
"helford/6523_vis_helford.mspec_b1.jpg"
"helford/7522_vis_helford.mspec.jpg"
"helford/7476_vis_helford.mspec_b1.jpg"
"helford/7374_vis_helford.mspec_b1.jpg"
"helford/7511_vis_helford.mspec_b1.jpg"
"helford/6375_vis_helford.mspec_b1.jpg"
"helford/6348_vis_helford.mspec_b1.jpg"
"helford/6529_vis_helford.mspec_b1.jpg"
"helford/7471_vis_helford.mspec_b1.jpg"
"helford/6467_vis_helford.mspec_b1.jpg"
"helford/6447_vis_helford.mspec_b1.jpg"
"helford/6473_vis_helford.mspec_b1.jpg"
"helford/7379_vis_helford.mspec_b1.jpg"
"helford/7433_vis_helford.mspec_b1.jpg"
"helford/6314_vis_helford.mspec_b1.jpg"
"helford/6495_vis_helford.mspec_b1.jpg"
"helford/6325_vis_helford.mspec_b1.jpg"
"helford/6499_vis_helford.mspec_b1.jpg"
"helford/7497_vis_helford.mspec_b1.jpg"
"helford/7491_vis_helford.mspec_b1.jpg"
"helford/6363_vis_helford.mspec_b1.jpg"
"helford/6516_vis_helford.mspec_b1.jpg"
"helford/7455_vis_helford.mspec_b1.jpg"
"helford/6429_vis_helford.mspec_b1.jpg"
"helford/7463_vis_helford.mspec_b1.jpg"
"helford/7441_vis_helford.mspec_b1.jpg"
"helford/6384_vis_helford.mspec_b1.jpg"
"helford/7517_vis_helford.mspec_b1.jpg"
"helford/6304_vis_helford.mspec_b1.jpg"
"helford/6339_vis_helford.mspec_b1.jpg"
"helford/6356_vis_helford.mspec_b1.jpg"
"helford/7411_vis_helford.mspec_b1.jpg"
"helford/6438_vis_helford.mspec_b1.jpg"
"helford/7503_vis_helford.mspec_b1.jpg"
"helford/7447_vis_helford.mspec_b1.jpg"
"helford/7426_vis_helford.mspec_b1.jpg"
"helford/6479_vis_helford.mspec_b1.jpg"
"helford/6487_vis_helford.mspec_b1.jpg"
"helford/7484_vis_helford.mspec_b1.jpg"
"helford/6414_vis_helford.mspec_b1.jpg"
"helford/6507_vis_helford.mspec_b1.jpg"
"helford/7388_vis_helford.mspec_b1.jpg"
"helford/6397_vis_helford.mspec_b1.jpg"
"helford/6371_vis_helford.mspec_b1.jpg"
"helford/6329_vis_helford.mspec_b1.jpg"
"helford/6421_vis_helford.mspec_b1.jpg"
"helford/7421_vis_helford.mspec_b1.jpg"
"penryn/145_Vis_Penryn.mspec_b1.jpg"
"penryn/128_Vis_Penryn.mspec_b1.jpg"
"penryn/SAM_5391.mspec.jpg"
"penryn/107_Vis_Penryn.mspec_b1.jpg"
"penryn/SAM_5415.mspec.jpg"
"penryn/135_Vis_Penryn.mspec_b1.jpg"
"penryn/136_Vis_Penryn.mspec_b1.jpg"
"penryn/146_Vis_Penryn.mspec_b1.jpg"
"penryn/123_Vis_Penryn.mspec_b1.jpg"
"penryn/127_Vis_Penryn.mspec_b1.jpg"
"penryn/109_Vis_Penryn.mspec_b1.jpg"
"penryn/130_Vis_Penryn.mspec_b1.jpg"
"penryn/148_Vis_Penryn.mspec_b1.jpg"
"penryn/120_Vis_Penryn.mspec_b1.jpg"
"penryn/126_Vis_Penryn.mspec_b1.jpg"
"penryn/104_Vis_Penryn.mspec_b1.jpg"
"penryn/SAM_5343.mspec.jpg"
"penryn/112_Vis_Penryn.mspec_b1.jpg"
"penryn/DSC_5769.mspec.jpg"
"penryn/132_Vis_Penryn.mspec_b1.jpg"
"penryn/DSC_5778.mspec.jpg"
"penryn/SAM_5379.mspec.jpg"
"penryn/DSC_5739.mspec.jpg"
"penryn/140_Vis_Penryn.mspec_b1.jpg"
"penryn/137_Vis_Penryn.mspec_b1.jpg"
"penryn/113_Vis_Penryn.mspec_b1.jpg"
"penryn/139_Vis_Penryn.mspec_b1.jpg"
"penryn/147_Vis_Penryn.mspec_b1.jpg"
"penryn/119_Vis_Penryn.mspec_b1.jpg"
"penryn/111_Vis_Penryn.mspec_b1.jpg"
"penryn/SAM_5403.mspec.jpg"
"penryn/116_Vis_Penryn.mspec_b1.jpg"
"penryn/131_Vis_Penryn.mspec_b1.jpg"
"penryn/124_Vis_Penryn.mspec_b1.jpg"
"penryn/129_Vis_Penryn.mspec_b1.jpg"
"penryn/141_Vis_Penryn.mspec_b1.jpg"
"penryn/143_Vis_Penryn.mspec_b1.jpg"
"penryn/133_Vis_Penryn.mspec_b1.jpg"
"penryn/103_Vis_Penryn.mspec_b1.jpg"
"penryn/144_Vis_Penryn.mspec_b1.jpg"
"penryn/125_Vis_Penryn.mspec_b1.jpg"
"penryn/142_Vis_Penryn.mspec_b1.jpg"
"penryn/138_Vis_Penryn.mspec_b1.jpg"
"penryn/118_Vis_Penryn.mspec_b1.jpg"
"penryn/106_Vis_Penryn.mspec_b1.jpg"
"penryn/122_Vis_Penryn.mspec_b1.jpg"
"penryn/105_Vis_Penryn.mspec_b1.jpg"
"penryn/117_Vis_Penryn.mspec_b1.jpg"
"penryn/DSC_5759.mspec.jpg"
"penryn/134_Vis_Penryn.mspec_b1.jpg"
"hayle/21_Vis_Hayle.mspec_b1.jpg"
"hayle/15_Vis_Hayle.mspec_b1.jpg"
"hayle/28_Vis_Hayle.mspec_b1.jpg"
"hayle/38_Vis_Hayle.mspec_b1.jpg"
"hayle/26_Vis_Hayle.mspec_b1.jpg"
"hayle/30_Vis_Hayle.mspec_b1.jpg"
"hayle/32_Vis_Hayle.mspec_b1.jpg"
"hayle/25_Vis_Hayle.mspec_b1.jpg"
"hayle/49_Vis_Hayle.mspec_b1.jpg"
"hayle/20_Vis_Hayle.mspec_b1.jpg"
"hayle/27_Vis_Hayle.mspec_b1.jpg"
"hayle/35_Vis_Hayle.mspec_b1.jpg"
"hayle/43_Vis_Hayle.mspec_b1.jpg"
"hayle/46_Vis_Hayle.mspec_b1.jpg"
"hayle/39_Vis_Hayle.mspec_b1.jpg"
"hayle/33_Vis_Hayle.mspec_b1.jpg"
"hayle/29_Vis_Hayle.mspec_b1.jpg"
"hayle/45_Vis_Hayle.mspec_b1.jpg"
"hayle/41_Vis_Hayle.mspec_b1.jpg"
"hayle/4_Vis_Hayle.mspec_b1.jpg"
"hayle/22_Vis_Hayle.mspec_b1.jpg"
"hayle/3_Vis_Hayle.mspec_b1.jpg"
"hayle/16_Vis_Hayle.mspec_b1.jpg"
"hayle/42_Vis_Hayle.mspec_b1.jpg"
"hayle/36_Vis_Hayle.mspec_b1.jpg"
"hayle/37_Vis_Hayle.mspec_b1.jpg"
"hayle/6_Vis_Hayle.mspec_b1.jpg"
"hayle/1_Vis_Hayle.mspec_b1.jpg"
"hayle/11_Vis_Hayle.mspec_b1.jpg"
"hayle/18_Vis_Hayle.mspec_b1.jpg"
"hayle/5_Vis_Hayle.mspec_b1.jpg"
"hayle/24_Vis_Hayle.mspec_b1.jpg"
"hayle/7_Vis_Hayle.mspec_b1.jpg"
"hayle/31_Vis_Hayle.mspec_b1.jpg"
"hayle/12_Vis_Hayle.mspec_b1.jpg"
"hayle/10_Vis_Hayle.mspec_b1.jpg"
"hayle/47_Vis_Hayle.mspec_b1.jpg"
"hayle/14_Vis_Hayle.mspec_b1.jpg"
"hayle/48_Vis_Hayle.mspec_b1.jpg"
"hayle/34_Vis_Hayle.mspec_b1.jpg"
"hayle/23_Vis_Hayle.mspec_b1.jpg"
"hayle/50_Vis_Hayle.mspec_b1.jpg"
"hayle/40_Vis_Hayle.mspec_b1.jpg"
"hayle/17_Vis_Hayle.mspec_b1.jpg"
"hayle/13_Vis_Hayle.mspec_b1.jpg"
"hayle/44_Vis_Hayle.mspec_b1.jpg"))

(define musselbed-filenames
  (list
"mawgan-porth/42_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/41_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/11_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/16_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/39_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/18_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/45_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/28_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/25_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/7_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/33_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/14_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/13_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/4_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/12_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/22_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/35_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/20_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/43_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/15_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/5_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/38_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/37_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/27_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/30_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/3_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/8_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/34_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/21_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/40_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/36_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/29_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/24_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/10_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/9_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/17_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/6_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/32_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/19_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/44_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/46_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/23_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/47_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/26_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/31_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/2_Vis_MawganPorth.mspec_b1.jpg"
"mawgan-porth/1_Vis_MawganPorth.mspec_b1.jpg"
"polzeath/143_Vis_Polzeath.mspec_b1.jpg"
"polzeath/128_Vis_Polzeath.mspec_b1.jpg"
"polzeath/116_Vis_Polzeath.mspec_b1.jpg"
"polzeath/137_Vis_Polzeath.mspec_b1.jpg"
"polzeath/117_Vis_Polzeath.mspec_b1.jpg"
"polzeath/135_Vis_Polzeath.mspec_b1.jpg"
"polzeath/114_Vis_Polzeath.mspec_b1.jpg"
"polzeath/150_Vis_Polzeath.mspec_b1.jpg"
"polzeath/140_Vis_Polzeath.mspec_b1.jpg"
"polzeath/148_Vis_Polzeath.mspec_b1.jpg"
"polzeath/101_Vis_Polzeath.mspec_b1.jpg"
"polzeath/134_Vis_Polzeath.mspec_b1.jpg"
"polzeath/120_Vis_Polzeath.mspec_b1.jpg"
"polzeath/121_Vis_Polzeath.mspec_b1.jpg"
"polzeath/113_Vis_Polzeath.mspec_b1.jpg"
"polzeath/102_Vis_Polzeath.mspec_b1.jpg"
"polzeath/127_Vis_Polzeath.mspec_b1.jpg"
"polzeath/145_Vis_Polzeath.mspec_b1.jpg"
"polzeath/151_Vis_Polzeath.mspec_b1.jpg"
"polzeath/133_Vis_Polzeath.mspec_b1.jpg"
"polzeath/126_Vis_Polzeath.mspec_b1.jpg"
"polzeath/106_Vis_Polzeath.mspec_b1.jpg"
"polzeath/125_Vis_Polzeath.mspec_b1.jpg"
"polzeath/107_Vis_Polzeath.mspec_b1.jpg"
"polzeath/111_Vis_Polzeath.mspec_b1.jpg"
"polzeath/112_Vis_Polzeath.mspec_b1.jpg"
"polzeath/103_Vis_Polzeath.mspec_b1.jpg"
"polzeath/147_Vis_Polzeath.mspec_b1.jpg"
"polzeath/118_Vis_Polzeath.mspec_b1.jpg"
"polzeath/119_Vis_Polzeath.mspec_b1.jpg"
"polzeath/141_Vis_Polzeath.mspec_b1.jpg"
"polzeath/108_Vis_Polzeath.mspec_b1.jpg"
"polzeath/139_Vis_Polzeath.mspec_b1.jpg"
"polzeath/122_Vis_Polzeath.mspec_b1.jpg"
"polzeath/144_Vis_Polzeath.mspec_0001-1509-2472.jpg"
"polzeath/105_Vis_Polzeath.mspec_b1.jpg"
"polzeath/146_Vis_Polzeath.mspec_b1.jpg"
"polzeath/149_Vis_Polzeath.mspec_b1.jpg"
"polzeath/109_Vis_Polzeath.mspec_b1.jpg"
"polzeath/124_Vis_Polzeath.mspec_b1.jpg"
"polzeath/130_Vis_Polzeath.mspec_b1.jpg"
"polzeath/123_Vis_Polzeath.mspec_b1.jpg"
"polzeath/129_Vis_Polzeath.mspec_b1.jpg"
"polzeath/142_Vis_Polzeath.mspec_b1.jpg"
"polzeath/136_Vis_Polzeath.mspec_b1.jpg"
"polzeath/131_Vis_Polzeath.mspec_b1.jpg"
"polzeath/138_Vis_Polzeath.mspec_b1.jpg"
"polzeath/104_Vis_Polzeath.mspec_b1.jpg"
"polzeath/115_Vis_Polzeath.mspec_b1.jpg"
"godrevy/145_Vis_Godrevey.mspec_b1.jpg"
"godrevy/115_Vis_Godrevey.mspec_b1.jpg"
"godrevy/148_Vis_Godrevey.mspec_b1.jpg"
"godrevy/150_Vis_Godrevey.mspec_b1.jpg"
"godrevy/111_Vis_Godrevey.mspec_b1.jpg"
"godrevy/137_Vis_Godrevey.mspec_b1.jpg"
"godrevy/147_Vis_Godrevey.mspec_b1.jpg"
"godrevy/109_Vis_Godrevey.mspec_b1.jpg"
"godrevy/127_Vis_Godrevey.mspec_b1.jpg"
"godrevy/144_Vis_Godrevey.mspec_b1.jpg"
"godrevy/107_Vis_Godrevey.mspec_b1.jpg"
"godrevy/149_Vis_Godrevey.mspec_b1.jpg"
"godrevy/110_Vis_Godrevey.mspec_b1.jpg"
"godrevy/139_Vis_Godrevey.mspec_b1.jpg"
"godrevy/142_Vis_Godrevey.mspec_b1.jpg"
"godrevy/146_Vis_Godrevey.mspec_b1.jpg"
"godrevy/140_Vis_Godrevey.mspec_b1.jpg"
"godrevy/128_Vis_Godrevey.mspec_b1.jpg"
"godrevy/119_Vis_Godrevey.mspec_v1.jpg"
"godrevy/136_Vis_Godrevey.mspec_b1.jpg"
"godrevy/113_Vis_Godrevey.mspec_b1.jpg"
"godrevy/133_Vis_Godrevey.mspec_b1.jpg"
"godrevy/114_Vis_Godrevey.mspec_b1.jpg"
"godrevy/103_Vis_Godrevey.mspec_b1.jpg"
"godrevy/130_Vis_Godrevey.mspec_b1.jpg"
"godrevy/141_Vis_Godrevey.mspec_b1.jpg"
"godrevy/129_Vis_Godrevey.mspec_b1.jpg"
"godrevy/143_Vis_Godrevey.mspec_b1.jpg"
"godrevy/125_Vis_Godrevey.mspec_b1.jpg"
"godrevy/112_Vis_Godrevey.mspec_b1.jpg"
"godrevy/121_Vis_Godrevey.mspec_b1.jpg"
"godrevy/135_Vis_Godrevey.mspec_b1.jpg"
"godrevy/122_Vis_Godrevey.mspec_b1.jpg"
"godrevy/116_Vis_Godrevey.mspec_b1.jpg"
"godrevy/138_Vis_Godrevey.mspec.jpg"
"godrevy/102_Vis_Godrevey.mspec_b1.jpg"
"godrevy/106_Vis_Godrevey.mspec_b1.jpg"
"godrevy/117_Vis_Godrevey.mspec_b1.jpg"
"godrevy/123_Vis_Godrevey.mspec_b1.jpg"
"godrevy/132_Vis_Godrevey.mspec_b1.jpg"
"godrevy/118_Vis_Godrevey.mspec_b1.jpg"
"godrevy/126_Vis_Godrevey.mspec_b1.jpg"
"godrevy/108_Vis_Godrevey.mspec_b1.jpg"
"godrevy/131_Vis_Godrevey.mspec_b1.jpg"
"godrevy/105_Vis_Godrevey.mspec_b1.jpg"
"godrevy/134_Vis_Godrevey.mspec_b1.jpg"
"godrevy/104_Vis_Godrevey.mspec_b1.jpg"
"godrevy/124_Vis_Godrevey.mspec_b1.jpg"
"godrevy/120_Vis_Godrevey.mspec_b1.jpg"
   ))


(define rockpool-filenames
  (list
"gylly/3657_vis_gylly.mspec_b1.jpg"
"gylly/3639_vis_gylly.mspec_b1.jpg"
"gylly/3551_vis_gylly.mspec_b1.jpg"
"gylly/3686_vis_gylly.mspec_b1.jpg"
"gylly/SAM_33010.mspec.jpg"
"gylly/3527_vis_gylly.mspec_b1.jpg"
"gylly/3716_vis_gylly.mspec_b1.jpg"
"gylly/3594_vis_gylly.mspec_b1.jpg"
"gylly/3766_vis_gylly.mspec_b1.jpg"
"gylly/3622_vis_gylly.mspec_b1.jpg"
"gylly/3546_vis_gylly.mspec_b1.jpg"
"gylly/3674_vis_gylly.mspec_b1.jpg"
"gylly/3583_vis_gylly.mspec_b1.jpg"
"gylly/3569_vis_gylly.mspec_b1.jpg"
"gylly/3704_vis_gylly.mspec_b1.jpg"
"gylly/3759_vis_gylly.mspec_b1.jpg"
"gylly/3662_vis_gylly.mspec_b1.jpg"
"gylly/3627_vis_gylly.mspec_b1.jpg"
"gylly/3633_vis_gylly.mspec_b1.jpg"
"gylly/3609_vis_gylly.mspec_b1.jpg"
"gylly/3575_vis_gylly.mspec_b1.jpg"
"gylly/3564_vis_gylly.mspec_b1.jpg"
"gylly/3615_vis_gylly.mspec_b1.jpg"
"gylly/SAM_4937.mspec.jpg"
"gylly/SAM_4765.mspec.jpg"
"gylly/DSC_5864.mspec.jpg"
"gylly/SAM_4778.mspec.jpg"
"gylly/3698_vis_gylly.mspec_b1.jpg"
"gylly/3453_vis_gylly.mspec_b1.jpg"
"gylly/3728_vis_gylly.mspec_b1.jpg"
"gylly/SAM_3304.mspec.jpg"
"gylly/SAM_5091.mspec.jpg"
"gylly/3668_vis_gylly.mspec_b1.jpg"
"gylly/3534_vis_gylly.mspec_b1.jpg"
"gylly/3644_vis_gylly.mspec_b1.jpg"
"gylly/SAM_4898.mspec.jpg"
"gylly/DSC_5860.mspec.jpg"
"gylly/SAM_4715.mspec.jpg"
"gylly/3587_vis_gylly.mspec_b1.jpg"
"gylly/3746_vis_gylly.mspec_b1.jpg"
"gylly/SAM_5103.mspec.jpg"
"gylly/3446_vis_gylly.mspec_b1.jpg"
"gylly/SAM_5115.mspec.jpg"
"gylly/3754_vis_gylly.mspec_b1.jpg"
"gylly/3308_vis_gylly.mspec_b1.jpg"
"gylly/3734_vis_gylly.mspec_b1.jpg"
"gylly/3771_vis_gylly.mspec_b1.jpg"
"flushing/109_Vis_Flushing.mspec_b1.jpg"
"flushing/117_Vis_Flushing.mspec_b1.jpg"
"flushing/132_Vis_Flushing.mspec_b1.jpg"
"flushing/133_Vis_Flushing.mspec_b1.jpg"
"flushing/127_Vis_Flushing.mspec_b1.jpg"
"flushing/134_Vis_Flushing.mspec_b1.jpg"
"flushing/144_Vis_Flushing.mspec_b1.jpg"
"flushing/146_Vis_Flushing.mspec_b1.jpg"
"flushing/138_Vis_Flushing.mspec_b1.jpg"
"flushing/108_Vis_Flushing.mspec_b1.jpg"
"flushing/137_Vis_Flushing.mspec_b1.jpg"
"flushing/131_Vis_Flushing.mspec_b1.jpg"
"flushing/105_Vis_Flushing.mspec_b1.jpg"
"flushing/126_Vis_Flushing.mspec_b1.jpg"
"flushing/114_Vis_Flushing.mspec_b1.jpg"
"flushing/118_Vis_Flushing.mspec_b1.jpg"
"flushing/128_Vis_Flushing.mspec_b1.jpg"
"flushing/102_Vis_Flushing.mspec_b1.jpg"
"flushing/129_Vis_Flushing.mspec_b1.jpg"
"flushing/124_Vis_Flushing.mspec_b1.jpg"
"flushing/136_Vis_Flushing.mspec_b1.jpg"
"flushing/112_Vis_Flushing.mspec_b1.jpg"
"flushing/113_Vis_Flushing.mspec_b1.jpg"
"flushing/123_Vis_Flushing.mspec_b1.jpg"
"flushing/151_Vis_Flushing.mspec_b1.jpg"
"flushing/111_Vis_Flushing.mspec_b1.jpg"
"flushing/116_Vis_Flushing.mspec_b1.jpg"
"flushing/104_Vis_Flushing.mspec_b1.jpg"
"flushing/125_Vis_Flushing.mspec_b1.jpg"
"flushing/106_Vis_Flushing.mspec_b1.jpg"
"flushing/121_Vis_Flushing.mspec_b1.jpg"
"flushing/120_Vis_Flushing.mspec_b1.jpg"
"flushing/103_Vis_Flushing.mspec_b1.jpg"
"flushing/145_Vis_Flushing.mspec_b1.jpg"
"flushing/139_Vis_Flushing.mspec_b1.jpg"
"flushing/119_Vis_Flushing.mspec_b1.jpg"
"flushing/135_Vis_Flushing.mspec_b1.jpg"
"flushing/107_Vis_Flushing.mspec_b1.jpg"
"flushing/142_Vis_Flushing.mspec_b1.jpg"
"flushing/141_Vis_Flushing.mspec_b1.jpg"
"flushing/122_Vis_Flushing.mspec_b1.jpg"
"flushing/140_Vis_Flushing.mspec_b1.jpg"
"flushing/101_Vis_Flushing.mspec_b1.jpg"
"flushing/115_Vis_Flushing.mspec_b1.jpg"
"flushing/110_Vis_Flushing.mspec_b1.jpg"
"flushing/130_Vis_Flushing.mspec_b1.jpg"
"st-mawes/48_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/28_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/11_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/35_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/34_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/37_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/49_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/12_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/33_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/4_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/39_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/41_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/2_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/30_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/14_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/13_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/1_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/44_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/24_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/32_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/6_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/16_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/23_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/9_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/15_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/8_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/42_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/10_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/7_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/26_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/21_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/17_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/27_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/45_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/46_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/29_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/36_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/50_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/5_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/38_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/47_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/25_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/3_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/31_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/40_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/22_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/43_Vis_St_Mawes.mspec_b1.jpg"
"st-mawes/19_Vis_St_Mawes.mspec_b1.jpg"
   ))

;; -----------

(define rockpool-crab-filenames
(list
"292_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"643_J_Vis_StMaw.mspec.png.autogimp.png"
"353_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"572_A_Vis_StMaw_020513.mspec_b1.png.auto.png"
"508_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"573_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"556_A_Vis_StMaw.mspec_b1.png.auto.png"
"595_A_Vis_StMaw.mspec_b1.png.auto.png"
"78_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"635_A_Vis_StMaw.mspec_b1.png.auto.png"
"538_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"540_A_Vis_StMaw.mspec_b1.png.auto.png"
"293_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"Flushing_A_7531.mspec_b1.png.auto.png"
"517_A_Vis_StMaw.mspec_b1.png.auto.png"
"341_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"338_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"314_A_Vis_Falmouth_020913.mspec_b1.png.auto.png"
"555_A_Vis_StMaw.mspec_b1.png.auto.png"
"535_J_Vis_StMaw.mspec_b1.png.auto.png"
"572_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"356_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"566_J_Vis_StMaw.mspec_b1.png.auto.png"
"522_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"526_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"634_A_Vis_StMaw.mspec_b1.png.auto.png"
"531_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"625_A_Vis_StMaw.mspec_b1.png.auto.png"
"522_A_Vis_StMaw.mspec_b1.png.auto.png"
"352_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"521_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"Flushing_A_7540.mspec_b1.png.auto.png"
"588_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"533_J_Vis_StMaw.mspec.png.autogimp.png"
"637_J_Vis_StMaw.mspec_b1.png.auto.png"
"511_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"77_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"114_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"602_J_Vis_StMaw.mspec_b1.png.auto.png"
"532_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"525_J_Vis_StMaw.mspec_b1.png.auto.png"
"339_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"70_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"571_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"583_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"351_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"289_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"609_J_Vis_StMaw.mspec_b1.png.auto.png"
"612_J_Vis_StMaw.mspec_b1.png.auto.png"
"642_J_Vis_StMaw.mspec_b1.png.auto.png"
"342_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"73_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"61_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"563_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"343_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"302_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"513_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"567_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"585_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"646_J_Vis_StMaw.mspec.png.autogimp.png"
"584_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"509_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"543_A_Vis_StMaw.mspec_b1.png.auto.png"
"673_J_Vis_StMaw.mspec.png.autogimp.png"
"610_A_Vis_StMaw.mspec_b1.png.auto.png"
"551_A_Vis_StMaw.mspec_b1.png.auto.png"
"675_J_Vis_StMaw.mspec.png.autogimp.png"
"638_J_Vis_StMaw.mspec_b1.png.auto.png"
"576_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"576_A_Vis_StMaw_020513.mspec_b1.png.auto.png"
"672_J_Vis_StMaw.mspec.png.autogimp.png"
"582_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"288_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"616_J_Vis_StMaw.mspec_b1.png.auto.png"
"580_A_Vis_StMaw_020513.mspec_b1.png.auto.png"
"597_A_Vis_StMaw.mspec_b1.png.auto.png"
"664_J_Vis_StMaw.mspec.png.autogimp.png"
"550_A_Vis_StMaw.mspec_b1.png.auto.png"
"570_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"344_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"539_A_Vis_StMaw.mspec_b1.png.auto.png"
"518_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"575_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"514_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"568_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"574_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"601_J_Vis_StMaw.mspec_b1.png.auto.png"
"561_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"68_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"546_J_Vis_StMaw.mspec.png.autogimp.png"
"547_A_Vis_StMaw.mspec_b1.png.auto.png"
"624_A_Vis_StMaw.mspec_b1.png.auto.png"
"315_A_Vis_Falmouth_020913.mspec_b1.png.auto.png"
"676_J_Vis_StMaw.mspec_b1.png.auto.png"
"510_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"71_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"573_J_Vis_StMaw.mspec_b1.png.auto.png"
"566_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"313_A_Vis_Falmouth_020913.mspec_b1.png.auto.png"
"346_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"303_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"306_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"516_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"340_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"115_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"674_J_Vis_StMaw.mspec.png.autogimp.png"
"301_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"579_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"534_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"304_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"587_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"611_A_Vis_StMaw.mspec_b1.png.auto.png"
"596_A_Vis_StMaw.mspec_b1.png.auto.png"
"337_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"133_A_Vis_Flushing_2014.mspec_b1.png.auto.png"
"586_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"292_A_Vis_Falmouth_020913.mspec_b1.png.auto.png"
"284_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"63_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"530_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"291_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"581_J_Vis_Flushing_2014.mspec_b1.png.auto.png"
"552_A_Vis_StMaw.mspec_b1.png.auto.png"
"295_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"62_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"512_J_Vis_Falmouth_2014.mspec_b1.png.auto.png"
"667_J_Vis_StMaw.mspec.png.autogimp.png"
"64_A_Vis_Falmouth_2014.mspec_b1.png.auto.png"
 ))

(define mudflat-crab-filenames
  (list
"489_J_Vis_Penryn_2014.mspec.png.autogimp.png"
"176_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"393_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"175_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"4_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"209_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"crab5V_A_Hayle16.mspec_b1.png.auto.png"
"181_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"183_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"crab1V_A_Hayle16.mspec_b1.png.auto.png"
"crab2V_A_Hayle16.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7814.mspec_b1.png.auto.png"
"220_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"crab17V_J_Hayle16.mspec_b1.png.auto.png"
"174_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7852.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7876.mspec_b1.png.auto.png"
"DCS_J_Hayle16_7805.mspec_b1.png.auto.png"
"crab3V_A_Hayle16.mspec_b1.png.auto.png"
"crab4V_J_Hayle16.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7828.mspec_b1.png.auto.png"
"426_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"213_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"DCS_J_Hayle16_7782.mspec_b1.png.auto.png"
"crab6V_A_Hayle16.mspec_b1.png.auto.png"
"232_Vis_Penryn_2014.mspec_0001-1296-1864.png.auto.png"
"178_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7897.mspec_b1.png.auto.png"
"468_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"216_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7864.mspec_b1.png.auto.png"
"276_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"crab13V_J_Hayle16.mspec_b1.png.auto.png"
"466_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"crab19V_J_Hayle16.mspec_b1.png.auto.png"
"crab18V_J_Hayle16.mspec_b1.png.auto.png"
"177_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7870.mspec_b1.png.auto.png"
"DCS_J_Hayle16_7784.mspec_b1.png.auto.png"
"crab7V_J_Hayle16.mspec_b1.png.auto.png"
"661_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"crab8V_J_Hayle16.mspec_b1.png.auto.png"
"crab3V_J_Hayle16.mspec_b1.png.auto.png"
"428_J_Vis_Penryn_2014.mspec.png.autogimp.png"
"438_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7835.mspec_b1.png.auto.png"
"crab11V_J_Hayle16.mspec_b1.png.auto.png"
"406_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"crab12V_J_Hayle16.mspec_b1.png.auto.png"
"crab10V_J_Hayle16.mspec_b1.png.auto.png"
"208_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"crab4V_A_Hayle16.mspec_b1.png.auto.png"
"665_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7809.mspec_b1.png.auto.png"
"14_J_Vis_Penryn_2014.mspec.png.autogimp.png"
"479_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"467_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"498_J_Vis_Penryn_2014.mspec.png.autogimp.png"
"439_J_Vis_Penryn_2014.mspec.png.autogimp.png"
"6_J_Vis_Penryn_2014.mspec.png.autogimp.png"
"476_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"275_J_Vis_Penryn_2014.mspec.png.autogimp.png"
"277_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"662_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"469_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"218_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"crab6V_J_Hayle16.mspec_b1.png.auto.png"
"501_J_Vis_Penryn_2014.mspec.png.autogimp.png"
"crab20V_J_.Hayle16mspec_b1.png.auto.png"
"DCS_A_Hayle16_7841.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7882.mspec_b1.png.auto.png"
"488_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"179_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"631_A_Vis_Helford_2014.mspec_b1.png.auto.png"
"crab7V_A_Hayle16.mspec_b1.png.auto.png"
"247_Vis_Penryn_2014.mspec_0001-1294-2190.png.auto.png"
"12_J_Vis_Penryn_2014.mspec.png.autogimp.png"
"215_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"DCS_J_Hayle16_7790.mspec_b1.png.auto.png"
"crab9V_J_Hayle16.mspec_b1.png.auto.png"
"182_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"crab1V_J_Hayle16.mspec_b1.png.auto.png"
"crab2V_J_Hayle16.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7903.mspec_b1.png.auto.png"
"219_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"180_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"210_J_Vis_Helford_2014.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7858.mspec_b1.png.auto.png"
"crab14V_J_Hayle16.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7910.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7819.mspec_b1.png.auto.png"
"440_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"634_A_Vis_Helford_2014.mspec_b1.png.auto.png"
"228_Vis_Penryn_2014.mspec_b1.png.auto.png"
"5_J_Vis_Penryn_2014.mspec.png.autogimp.png"
"13_J_Vis_Penryn_2014.mspec.png.autogimp.png"
"465_J_Vis_Penryn_2014.mspec_b1.png.auto.png"
"DCS_A_Hayle16_7889.mspec_b1.png.auto.png"
"crab15V_J_Hayle16.mspec_b1.png.auto.png"
   ))

(define musselbed-crab-filenames
  (list
"86_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"13_Vis_Crab_MawganPorth.mspec_c1.png"
"7_Vis_Crab_MawganPorth.mspec_c1.png"
"90_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"2_Vis_Crab_MawganPorth.mspec_c1.png"
"331_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"88_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"161_J_Vis_Godrevy_2014.mspec_b1.png"
"374_J_Vis_Godrevy_2014.mspec_b1.png"
"89_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"9_Vis_Crab_MawganPorth.mspec_c1.png"
"93_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"6_Vis_Crab_MawganPorth.mspec_c1.png"
"546_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"11_J_MawganPorth_2016.mspec_b1.png"
"19_J_MawganPorth_2016.mspec_b1.png"
"328_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"603_J_Vis_Godrevy_2014.mspec_b1.png"
"160_J_Vis_Godrevy_2014.mspec_b1.png"
"316_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"377_J_Vis_Godrevy_2014.mspec_b1.png.auto.png"
"371_J_Vis_Godrevy_2014.mspec_b1.png.auto.png"
"03_A_MawganPorth_2016.mspec_b1.png"
"314_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"145_J_Vis_Godrevy_2014.mspec_b1.png"
"25_J_MawganPorth_2016.mspec_b1.png"
"149_J_Vis_Godrevy_2014.mspec_b1.png.auto.png"
"24_A_MawganPorth_2016.mspec_b1.png"
"144_J_Vis_Godrevy_2014.mspec_b1.png"
"376_J_Vis_Godrevy_2014.mspec_b1.png"
"21_A_MawganPorth_2016.mspec_b1.png"
"02_A_MawganPorth_2016.mspec_b1.png"
"1_Vis_Crab_MawganPorth.mspec_c1.png"
"326_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"20_A_MawganPorth_2016.mspec_b1.png"
"594_J_Vis_Godrevy_2014.mspec_b1.png"
"27_J_MawganPorth_2016.mspec_b1.png"
"85_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"14_J_MawganPorth_2016.mspec_b1.png"
"162_J_Vis_Godrevy_2014.mspec_b1.png.auto.png"
"617_J_Vis_Godrevy_2014.mspec_b1.png"
"548_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"08_J_MawganPorth_2016.mspec_b1.png"
"8_Vis_Crab_MawganPorth.mspec_c1.png"
"97_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"12_Vis_Crab_MawganPorth.mspec_c1.png"
"329_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"378_J_Vis_Godrevy_2014.mspec_b1.png.auto.png"
"92_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"26_J_MawganPorth_2016.mspec_b1.png"
"87_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"112_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"11_Vis_Crab_MawganPorth.mspec_c1.png"
"83_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"09_J_MawganPorth_2016.mspec_b1.png"
"4_Vis_Crab_MawganPorth.mspec_c1.png"
"96_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"545_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
"16_J_MawganPorth_2016.mspec_b1.png"
"330_J_Vis_Polzeath_2014.mspec_b1.png.auto.png"
   ))


(define (loadtest)
  (for-each
   (lambda (fn)
     (let ((image (js "new Image()")))
       (set! image.onerror
             (lambda ()
               (console.log (+ "IMAGE CHECK ERROR" fn))))
       (set! image.src (+ "images/" fn ))))
   (append
    (map (lambda (f) (+ "photos/rockpool/crabs/" f)) rockpool-crab-filenames)
    (map (lambda (f) (+ "photos/mudflat/crabs/" f)) mudflat-crab-filenames)
    (map (lambda (f) (+ "photos/musselbed/crabs/" f)) musselbed-crab-filenames)
    (map (lambda (f) (+ "photos/rockpool/di-crabs/" f)) rockpool-crab-filenames)
    (map (lambda (f) (+ "photos/mudflat/di-crabs/" f)) mudflat-crab-filenames)
    (map (lambda (f) (+ "photos/musselbed/di-crabs/" f)) musselbed-crab-filenames)
    (map (lambda (f) (+ "photos/rockpool/" f)) rockpool-filenames)
    (map (lambda (f) (+ "photos/mudflat/" f)) mudflat-filenames)
    (map (lambda (f) (+ "photos/musselbed/" f)) musselbed-filenames)
    (map (lambda (f) (+ "photos/rockpool/di-" f)) rockpool-filenames)
    (map (lambda (f) (+ "photos/mudflat/di-" f)) mudflat-filenames)
    (map (lambda (f) (+ "photos/musselbed/di-" f)) musselbed-filenames))))

;(loadtest)

(define (filename-to-type fn)
  (let ((a (fn.substring 0 2)))
    (cond
     ((eq? a "pe") "the Penryn river")
     ((eq? a "gy") "Gyllyngvase beach")
     (else
      "unknown beach"))))

(define photos
  (list
   (list
    (map (lambda (f) (list (string-append "photos/rockpool/" f) "Rockpool" "rockpool"
                           (string-append "photos/rockpool/map-" f)
                           )) rockpool-filenames)
    (map (lambda (f) (list (string-append "photos/rockpool/di-" f) "Rockpool" "rockpool"
                           (string-append "photos/rockpool/map-" f)
                           )) rockpool-filenames))
   (list
    (map (lambda (f) (list (string-append "photos/mudflat/" f) "Mudflat" "mudflat"
                           (string-append "photos/mudflat/map-" f)
                           )) mudflat-filenames)
    (map (lambda (f) (list (string-append "photos/mudflat/di-" f) "Mudflat" "mudflat"
                           (string-append "photos/mudflat/map-" f)
                           )) mudflat-filenames))
   (list
    (map (lambda (f) (list (string-append "photos/musselbed/" f) "Musselbed" "musselbed"
                           (string-append "photos/musselbed/map-" f)
                           )) musselbed-filenames)
    (map (lambda (f) (list (string-append "photos/musselbed/di-" f) "Musselbed" "musselbed"
                           (string-append "photos/musselbed/map-" f)
                           )) musselbed-filenames))
   (list
    (map (lambda (f) (list (string-append "photos/rockpool/crabs/" f) "Rockpool" "rockpool" "no map for crab")) rockpool-crab-filenames)
    (map (lambda (f) (list (string-append "photos/rockpool/di-crabs/" f) "Rockpool" "rockpool" "no map for crab")) rockpool-crab-filenames))
   (list
    (map (lambda (f) (list (string-append "photos/mudflat/crabs/" f) "Mudflat" "mudflat" "no map for crab")) mudflat-crab-filenames)
    (map (lambda (f) (list (string-append "photos/mudflat/di-crabs/" f) "Mudflat" "mudflat" "no map for crab")) mudflat-crab-filenames))
   (list
    (map (lambda (f) (list (string-append "photos/musselbed/crabs/" f) "Musselbed" "musselbed" "no map for crab")) musselbed-crab-filenames)
    (map (lambda (f) (list (string-append "photos/musselbed/di-crabs/" f) "Musselbed" "musselbed" "no map for crab")) musselbed-crab-filenames))
   ))

;;(map (lambda (f) (list (string-append "photos/mudflat/crabs/" f) (filename-to-type f) "mudflat" "no map for crab")) mudflat-crab-filenames)
;;(map (lambda (f) (list (string-append "photos/mudflat/di-crabs/" f) (filename-to-type f) "mudflat" "no map for crab")) mudflat-crab-filenames))

;;(map (lambda (f) (list (string-append "photos/musselbed/crabs/" f) (filename-to-type f) "musselbed" "no map for crab")) musselbed-crab-filenames)
;;(map (lambda (f) (list (string-append "photos/musselbed/di-crabs/" f) (filename-to-type f) "musselbed" "no map for crab")) musselbed-crab-filenames))

(define (photo-filename l) (list-ref l 0))
(define (photo-desc l) (list-ref l 1))
(define (photo-habitat l) (list-ref l 2))
(define (photo-map l) (list-ref l 3))

(define (rockpool-photos l) (list-ref l 0))
(define (mudflat-photos l) (list-ref l 1))
(define (musselbed-photos l) (list-ref l 2))
(define (rockpool-crab-photos l) (list-ref l 3))
(define (mudflat-crab-photos l) (list-ref l 4))
(define (musselbed-crab-photos l) (list-ref l 5))

(define (button-image)
  (find-image (choose (list "button-1.png" "button-2.png" "button-3.png"))))

(define (small-button-image)
  (find-image (choose (list "button-s1.png"))))


(define (button-sound)
  (play-sound
   (choose
    (list
     "bubble-1.wav"
     "bubble-2.wav"
     "bubble-3.wav"
     "bubble-7.wav"
     ))))



;; get from image structure
(define image-width (* screen-width 1))
(define image-height (* screen-height 1))
(define image-centre-x (/ image-width 2))
(define image-centre-y (/ image-height 2))

(define safe-x 0.2)
(define safe-y 0.2)
(define safe-x-px (* safe-x image-width))
(define safe-y-px (* safe-y image-height))

;; (define (generate-image-pos)
;;   (list (- (* screen-width (+ safe-x (* (rndf) (- 1 (* safe-x 2))))) image-centre-x)
;;         (- (* screen-height (+ safe-y (* (rndf) (- 1 (* safe-y 2))))) image-centre-y)))

(define (generate-screen-pos)
  (list (+ safe-x-px
           (* (rndf) (- image-width (* safe-x-px 2))))
        (+ safe-y-px
           (* (rndf) (- image-height (* safe-y-px 2))))))

(define (pos-to-image-index pos img)
  (let ((x (Math.floor (* (/ (vx pos) image-width) img.width)))
        (y (Math.floor (* (/ (vy pos) image-height) img.height))))
    (* (+ (* y img.width) x) 4))) ;; rbga

(define (get-pixel-val pos imagedata img)
  (let ((index (pos-to-image-index pos img)))
    (list-ref imagedata.data index)))

(define (generate-crab-pos c)
  (let ((example (car (nightjar-images (game-data c))))
        (pos (generate-screen-pos))
        (canvas (document.createElement "canvas")))
    (let ((context (canvas.getContext "2d"))
          (ex-map (find-image (photo-map example))))
      ;; maybe the map doesn't exist for all backgrounds...
      (when ex-map
            (context.drawImage ex-map 0 0)
            (let ((imagedata (context.getImageData 0 0 ex-map.width ex-map.height))
                  ;; use a safety counter in case of entirely black images!
                  (safe 0))
              (while (and (< safe 500)
                          (< (get-pixel-val pos imagedata ex-map) 127))
                     (set! safe (+ safe 1))
                     (set! pos (generate-screen-pos))))))
    pos))

(define default-button-x (- (/ screen-width 2) 0))
(define default-button-y (+ (/ screen-height 2) 200))
(define button-gap 250)

(define (build-bubble id vel fuzz age)
  (list id vel fuzz age))

(define (bubble-id b) (list-ref b 0))
(define (bubble-modify-id v b) (list-replace b 0 v))
(define (bubble-vel b) (list-ref b 1))
(define (bubble-modify-vel v b) (list-replace b 1 v))
(define (bubble-fuzz b) (list-ref b 2))
(define (bubble-age b) (list-ref b 3))
(define (bubble-modify-age v b) (list-replace b 3 v))

(define bubble-pos (list (list 100 100) (list 200 200)))

(define (update-bubble-pos c)
  (set! bubble-pos
        (foldl
         (lambda (b r)
           (if (not (button-drawable b))
               (append
                r (list (list (+ 20 (button-x b) (* (/ (button-w b) 2) 0.6))
                              (+ 10 (button-y b) (* (/ (button-h b) 2) 0.6)))))
               r))
         ()
         (game-buttons c)))
  ;; num bubbles same for num buttons
  (update-bubbles-size! (* (length bubble-pos) 40))
  c)

(define (bubbles-hit! id c)
  (particle-system-user-update!
   (lambda (bubble)
     (if (eq? (bubble-id bubble) id)
         (bubble-modify-vel (v2mul (list (* (crndf) 0.5) (- 0 (rndf))) 5) bubble)
         (bubble-modify-vel (list 1000 1000) bubble)))
   (nightjar-bubbles (game-data c))))

(define bubble-max-opacity 0.5)

(define (bubbles-reset bubbles)
  (particle-system-init
   (lambda (i)
     (list
      (list 9999 9999) ;; pos
      (list 0 0)
      bubble-max-opacity
      (build-bubble
         i (vec2 0 (* (- 0 (rndf)) 0.5)) ;; vel
         (rndf) ;; fuzz
         (* 200 (rndf))) ;; age
      ))
   bubbles))

(define (build-bubbles)
  (particle-system-modify-update-hook
   (lambda (pos scale trans bubble)
     (if (> (bubble-age bubble) 200)
         (if (null? bubble-pos)
             (list
              (list 9999 9999)
              (list 0 0) 1 (bubble-modify-age 0 bubble))
             (let ((id (random (length bubble-pos))))
               (list
                (v2add
                 (list-ref bubble-pos id)
                 (v2mul2 (rndcirc2d) (vec2 120 80)))
                (list 0 0) bubble-max-opacity
                (bubble-modify-id
                 id (bubble-modify-age
                     0 (bubble-modify-vel
                        (vec2 0 (- 0 (* (rndf) 0.5)))
                        bubble))))))
         (list
          (list (+ (vx pos) (vx (bubble-vel bubble)))
                (+ (vy pos) (vy (bubble-vel bubble))))
          (list
           (min 0.5 (/ (bubble-age bubble) 50))
           (min 0.5 (/ (bubble-age bubble) 50)))
          (max 0 (* (/ (- 200 (bubble-age bubble)) 200) bubble-max-opacity))
          (bubble-modify-age (+ (bubble-age bubble) 1) bubble))))
   (particle-system-init
    (lambda (i)
      (list
       (list 9999 9999) ;; pos
       (list 0 0)
       bubble-max-opacity (build-bubble
          i (vec2 0 (* (- 0 (rndf)) 0.5)) ;; vel
          (rndf) ;; fuzz
          (* 200 (rndf))) ;; age
       ))
    (build-particle-system
     100 (list
          (find-image "bubble-1.png")
          (find-image "bubble-2.png")
          (find-image "bubble-3.png")
          (find-image "bubble-4.png")
          (find-image "bubble-5.png")
          (find-image "bubble-6.png")
          (find-image "bubble-7.png")
          (find-image "bubble-8.png")
          (find-image "bubble-9.png")
          )))))

(define bubbles ())

(define (update-bubbles-size! s)
  (set! bubbles (particle-system-modify-size s bubbles)))


(define (empty-nightjar-data)
  (list 0 0 0 "" #f 0 () () 0 (sprite 0 0 "wrong.png" 0) 0 "???" () 0 0
        bubbles 0))

(define (nightjar-start-time g) (list-ref g 0))
(define (nightjar-modify-start-time v g) (list-replace g 0 v))
(define (nightjar-photo-time g) (list-ref g 1))
(define (nightjar-modify-photo-time v g) (list-replace g 1 v))
(define (nightjar-player-id g) (list-ref g 2))
(define (nightjar-modify-player-id v g) (list-replace g 2 v))
(define (nightjar-player-type g) (list-ref g 3))
(define (nightjar-modify-player-type v g) (list-replace g 3 v))
(define (nightjar-played-before g) (list-ref g 4))
(define (nightjar-modify-played-before v g) (list-replace g 4 v))
(define (nightjar-player-age g) (list-ref g 5))
(define (nightjar-modify-player-age v g) (list-replace g 5 v))
(define (nightjar-images g) (list-ref g 6))
(define (nightjar-modify-images v g) (list-replace g 6 v))
(define (nightjar-crab-pos g) (list-ref g 7))
(define (nightjar-modify-crab-pos v g) (list-replace g 7 v))
(define (nightjar-score g) (list-ref g 8))
(define (nightjar-modify-score v g) (list-replace g 8 v))
(define (nightjar-sprite g) (list-ref g 9))
(define (nightjar-modify-sprite v g) (list-replace g 9 v))
(define (nightjar-level g) (list-ref g 10))
(define (nightjar-modify-level v g) (list-replace g 10 v))
(define (nightjar-username g) (list-ref g 11))
(define (nightjar-modify-username v g) (list-replace g 11 v))
(define (nightjar-crabs g) (list-ref g 12))
(define (nightjar-modify-crabs v g) (list-replace g 12 v))
(define (nightjar-crab-rotation g) (list-ref g 13))
(define (nightjar-modify-crab-rotation v g) (list-replace g 13 v))
(define (nightjar-game-id g) (list-ref g 14))
(define (nightjar-modify-game-id v g) (list-replace g 14 v))
(define (nightjar-bubbles g) (list-ref g 15))
(define (nightjar-results-num g) (list-ref g 16))
(define (nightjar-modify-results-num v g) (list-replace g 16 v))

(define (time-left c)
  (* (- (game-time c)
        (nightjar-start-time (game-data c)))
     0.001))

;; setup new game
(define (nightjar-new-game c)
  (nightjar-game
   (game-modify-data
    (lambda (d)
      (nightjar-modify-start-time
       (game-time c)
       (nightjar-modify-crab-rotation
        (* 2 (rndf) 3.141) ; good enuf
        (nightjar-modify-crab-pos
         (generate-crab-pos c)
         (nightjar-modify-sprite
          (sprite -999 -999 "right.png" 0)
          d)))))
    c)))

;; load images and reset (calling new-game above)
(define (nightjar-new-game-reset-timer c)
  (set! bubble-pos ())
  ;; start image load
  (load-images-mutate
   (lambda (c)
     (msg "new-game-reset-timer")
     (nightjar-new-game
      (game-modify-data
       (lambda (d)
         ;; now loaded - remove previous images and set photo time
         (nightjar-modify-images
          (cdr (nightjar-images d))
          (nightjar-modify-crabs
           (cdr (nightjar-crabs d))
           (nightjar-modify-photo-time
            (game-time c) d))))
       c)))
   (list
    ;; load the *next* images
    (photo-filename (list-ref (nightjar-images (game-data c)) 1))
    (photo-map (list-ref (nightjar-images (game-data c)) 1))
    (photo-filename (list-ref (nightjar-crabs (game-data c)) 1))))
  ;; set up loading screen before loading
  (game-modify-buttons
   ()
   (game-modify-render
    (lambda (ctx)
      (let ((example (car (nightjar-images (game-data c)))))
        (ctx.drawImage
         (find-image (photo-filename example))
         0 0)
        (particle-system-render ctx (nightjar-bubbles (game-data c)))
        (nightjar-all-text ctx "Loading your next crab...")))
    c)))


(define (get-crabs-for-a-habitat tri)
  (shuffle
   (append
    (crop (shuffle (list-ref (rockpool-crab-photos photos) tri)) num-crabs-per-habitat)
    (crop (shuffle (list-ref (mudflat-crab-photos photos) tri)) num-crabs-per-habitat)
    (crop (shuffle (list-ref (musselbed-crab-photos photos) tri)) num-crabs-per-habitat))))

(define (habitat-photos tri habitat-list)
  (map2
   (lambda (a b)
     (list a b))
   (crop (shuffle (list-ref habitat-list tri)) num-bgs-per-habitat)
   (get-crabs-for-a-habitat tri)))

(define (get-image-pairs tri)
  (shuffle
   (append
    (habitat-photos tri (rockpool-photos photos))
    (habitat-photos tri (mudflat-photos photos))
    (habitat-photos tri (musselbed-photos photos)))))

(define (unzip l n)
  (map (lambda (i) (list-ref i n)) l))

(define (nightjar-new-game-images c)
  (let ((tri (if (eq? (nightjar-player-type (game-data c)) "human") 0 1)))
    (button-sound)
    (let ((image-pairs (get-image-pairs tri)))
      (load-images-mutate
       (lambda (c)
         (nightjar-new-game
          (game-modify-data
           (lambda (d)
             (nightjar-modify-photo-time
              (game-time c)
              (nightjar-modify-images
               (unzip image-pairs 0)
               (nightjar-modify-crabs
                (unzip image-pairs 1) d))))
           c)))
       (list
        (photo-filename (list-ref (car image-pairs) 0))
        (photo-map (list-ref (car image-pairs) 0))
        (photo-filename (list-ref (car image-pairs) 1))))
      (game-modify-buttons
       ()
       (game-modify-render
        (lambda (ctx)
          (nightjar-all-text ctx "Loading your first crab..."))
        c)))))

(set! randseed (choose (list 7.21 1)))

(define (seeded-choose l)
  (list-ref l (Math.floor (* (seeded-random) (length l)))))

(define (random-weed)
  (seeded-choose
   (list
    "cutoutweed.png"
    "cutoutweed2.png"
    "cutoutweed3.png"
    "cutoutweed4.png"
    "cutoutweed5.png"
    "cutoutweed6.png"
    "cutoutweed7.png"
    "cutoutweed8.png"
    )))


(define pos-list
  (build-list
   25 (lambda (i)
        (list (* (seeded-random) screen-width)
              (* (rndf) screen-height)
              (seeded-random)
              (random-weed)))))


(define (draw-weed ctx c)
  (ctx.save)
  (set! ctx.globalAlpha 0.3)
  (for-each
   (lambda (pos)
     (let ((img (find-image (list-ref pos 3))))
       (ctx.save)
       (ctx.translate (car pos) (+ screen-height 100))
;;       (ctx.translate (/ img.width 2) img.height)
       (ctx.scale
        (+ (list-ref pos 2) 0.5)
        (+ (list-ref pos 2) 0.5))

       (ctx.rotate (* 0.02 (sin (+ (* (list-ref pos 2) 5)
                                   (* 0.001 (game-time c))))))
;;       (ctx.translate (- 0 (/ img.width 2)) (- 0 img.height))
       (ctx.drawImage img (/ -img.width 2) -img.height)
       (ctx.restore)))
   pos-list)
  (ctx.restore))

;;(list-ref (cadr e) 0)

(define (render-results-1 ctx data yp)
  (let ((xpos 530) (ypos yp)
        (bar-start (+ yp 450))
        (maxtime (Math.max
                  (cadr (cadr (list-ref (car data) 0)))
                  (cadr (cadr (list-ref (car data) 1)))
                  (cadr (cadr (list-ref (car data) 2))))))

    (centre-text2 ctx "Best crabs per habitat" (+ xpos 260) (- ypos 20))
    (set! ctx.font "normal 17pt open-sans")
    (wrap-text ctx "There are crabs from rockpools, mudflats and musselbeds in the game, which crabs are hardest to spot in each habitat?" 0 (+ ypos 15) 750 30)
    (set! ypos (+ ypos 100))
    (set! ctx.font "normal 25pt open-sans")

    (ctx.save)
    (ctx.translate 460 (+ yp 280))
    (ctx.rotate (/ -3.141 2))
    (centre-text2 ctx "Average time" 0 0)
    (centre-text2 ctx "to find crab" 0 35)
    (ctx.restore)

    (index-for-each
     (lambda (i e)
       (let ((habitat (car e))
             (crab-type (list-ref (cadr e) 0))
             (time (list-ref (cadr e) 1)))

         (let ((crab-name (cond
                           ((eq? crab-type "rockpool") "Rockpool crabs")
                           ((eq? crab-type "musselbed") "Musselbed crabs")
                           (else "Mudflat crabs"))))

           (set! ctx.fillStyle "#039a8b")
           (let ((height (* (/ time maxtime) 250)))
             (roundRect ctx (+ xpos (* i 200)) (- bar-start height)
                        150 height 10 #t #f)
             (set! ctx.fillStyle "#fff")

             (centre-text2
              ctx
              (cond
               ((eq? habitat "rockpool") "Rockpool")
               ((eq? habitat "musselbed") "Musselbed")
               (else "Mudflat"))
              (+ xpos (+ 75 (* i 200)))
              (+ ypos 390))

             (centre-text2
              ctx "habitat"
              (+ xpos (+ 75 (* i 200)))
              (+ ypos 425))

             (set! ctx.font "normal 20pt open-sans")
             (centre-text2 ctx (time-to-seconds time)
                           (+ xpos (+ 75 (* i 200)))
                           (- bar-start 20 (/ height 2)))
             (centre-text2 ctx "Seconds"
                           (+ xpos (+ 75 (* i 200)))
                           (- (+ bar-start 20) (/ height 2)))

             (ctx.drawImage (find-image (+ crab-type "-crab.png"))
                            (+ 10 xpos (* i 200))
                            (- bar-start height 140))
             (set! ctx.font "normal 16pt open-sans")
             (centre-text2 ctx crab-name
                           (+ xpos (+ 75 (* i 200)))
                           (- bar-start height 10))
             (set! ctx.font "normal 25pt open-sans")

             ))))
     (list-ref data 0)))
  (set! ctx.font "normal 30pt open-sans")
  )

(define (render-results-2 ctx data yp)
  (let ((xpos 530) (ypos yp)
        (bar-start (+ yp 450))
        (maxtime (cadr (list-ref (list-ref data 1) 2))))
    (centre-text2 ctx "Best habitat for hiding in" (+ xpos 250) (- ypos 20))
    (set! ctx.font "normal 20pt open-sans")
    (centre-text2 ctx "Are crabs harder to find in certain habitats?" (+ xpos 270) (+ ypos 15))
    (set! ypos (+ ypos 100))
    (set! ctx.font "normal 25pt open-sans")

    (ctx.save)
    (ctx.translate 460 (+ yp 280))
    (ctx.rotate (/ -3.141 2))
    (centre-text2 ctx "Average time" 0 0)
    (centre-text2 ctx "to find crab" 0 35)
    (ctx.restore)

    (index-for-each
     (lambda (i ee)
       (let ((habitat (car ee))
             (time (cadr ee)))

         (set! ctx.fillStyle "#039a8b")
         (let ((height (* (/ time maxtime) 400)))
           (roundRect ctx (+ xpos (* i 200)) (- bar-start height)
                      150 height 10 #t #f)
         (set! ctx.fillStyle "#fff")

         (centre-text2
          ctx
          (cond
           ((eq? habitat "rockpool") "Rockpool")
           ((eq? habitat "musselbed") "Musselbed")
           (else "Mudflat"))
          (+ xpos (+ 75 (* i 200)))
          (+ ypos 390))

         (set! ctx.font "normal 20pt open-sans")
         (centre-text2 ctx (time-to-seconds time)
                       (+ xpos (+ 75 (* i 200)))
                       (- bar-start 20 (/ height 2)))
         (centre-text2 ctx "Seconds"
                       (+ xpos (+ 75 (* i 200)))
                       (- (+ bar-start 20) (/ height 2)))
         (set! ctx.font "normal 25pt open-sans")
         )))
     (list-ref data 1))
    (set! ctx.font "normal 30pt open-sans")
    ))

(define (render-results-3 ctx data yp)
  (let ((xpos 530) (ypos yp)
        (bar-start (+ yp 450))
        (maxtime (cadr (list-ref (list-ref data 2) 1))))
    (centre-text2 ctx "Best predator vision" (+ xpos 270) (- ypos 20))
    (set! ctx.font "normal 20pt open-sans")
    (centre-text2 ctx "Which predators have the crabs evolved to hide from?" (+ xpos 270) (+ ypos 15))
    (set! ctx.font "normal 25pt open-sans")
    (set! ypos (+ ypos 100))

    (ctx.save)
    (ctx.translate 460 (+ yp 280))
    (ctx.rotate (/ -3.141 2))
    (centre-text2 ctx "Average time" 0 0)
    (centre-text2 ctx "to find crab" 0 35)
    (ctx.restore)

    (index-for-each
     (lambda (i ee)
       (let ((predator (car ee))
             (time (cadr ee)))

         (set! ctx.fillStyle "#039a8b")
         (let ((height (* (/ time maxtime) 400)))
           (roundRect ctx (+ xpos (* i 300)) (- bar-start height)
                      250 height 10 #t #f)
         (set! ctx.fillStyle "#fff")
         (set! ctx.font "normal 30pt open-sans")

         (centre-text2
          ctx
          (cond
           ((eq? predator "human") "Human")
           (else "Pollock"))
          (+ xpos (+ 125 (* i 300)))
          (+ ypos 390))

         (set! ctx.font "normal 16pt open-sans")
         (wrap-text
          ctx
          (cond
           ((eq? predator "human") "Trichromatic - sees red, green and blue")
           (else "Dichromatic - sees yellow and blue"))
          (- (+ xpos (+ 125 (* i 300)))  (/ screen-width 2))
          (+ ypos 415)
          300 22)
         (set! ctx.font "normal 30pt open-sans")

         (centre-text2 ctx (time-to-seconds time)
                       (+ xpos (+ 125 (* i 300)))
                       (- bar-start 20 (/ height 2)))
         (centre-text2 ctx "Seconds"
                       (+ xpos (+ 125 (* i 300)))
                       (- (+ bar-start 20) (/ height 2)))
         )))
     (list-ref data 2))
    (set! ctx.font "normal 30pt open-sans")
    ))

(define title-offset (random 100))
(define button-offset (random 100))
(define crab-offset (random 200))

(define (nightjar-intro c)
    (game-modify-timeout
     (lambda ()
       (set! window.location "/"))
    (update-bubble-pos
     (game-modify-data
      (lambda (d)
        (empty-nightjar-data))
      (game-modify-render
       (lambda (ctx)
         (draw-weed ctx c)
         (particle-system-render ctx (nightjar-bubbles (game-data c)))
         (ctx.drawImage (find-image "crab1.png") 0 (+ crab-offset 355))
         (ctx.drawImage (find-image "crab2.png") 1240 (+ crab-offset 350))

	 (set! ctx.font "normal 75pt open-sans")
	 (set! ctx.fillStyle "#fff")
	 (wrap-text ctx "Camouflaged Crabs" 0 (+ title-offset 200) 1300 100)
	 (set! ctx.font "normal 30pt open-sans")

         (set! ctx.font "normal 25pt open-sans")
         (wrap-text ctx "How camouflaged are crabs to the eyes of predators and in different habitats?" 0 (+ title-offset 300) 800 40)
         (wrap-text ctx "Play this game to help us find out." 0 (+ title-offset 420) 1000 40)
         (set! ctx.font "normal 30pt open-sans")
         (set! ctx.font "normal 30pt open-sans"))

       (game-modify-buttons
        (list

         (empty-image-button
          "Start"
          (- default-button-x 200)
          (+ default-button-y button-offset)
          empty-button-width empty-button-height
          "none"
          (lambda (c)
            (bubbles-hit! 0 c)
            (button-sound)
            (nightjar-species-screen c)))

         (empty-image-button
          "The science"
          (+ default-button-x 200)
          (+ default-button-y button-offset)
          empty-button-width empty-button-height
          "none"
          (lambda (c)
            (bubbles-hit! 1 c)
            (button-sound)
            (nightjar-about c)))
         )
        c))))))

(define (nightjar-about c)
  (update-bubble-pos
   (game-modify-render
    (lambda (ctx)
      (draw-weed ctx c)
      (particle-system-render ctx (nightjar-bubbles (game-data c)))
      (ctx.drawImage (find-image "crab1.png") 0 555)
      (ctx.drawImage (find-image "crab2.png") 1240 550)

      (set! ctx.font "normal 75pt open-sans")
      (wrap-text ctx "About the project" 0 150 1300 100)
      (set! ctx.font "normal 22pt open-sans")

      (wrap-text-left ctx "Scientists at the University of Exeter’s Sensory Ecology and Evolution Lab study animal colouration and vision. One main area of their research explores how animals use camouflage to avoid predation. This includes how visible shore crabs are to different predators and in different habitats." 230 230 1200 40)
      (wrap-text-left ctx "This computer experiment was originally designed to aid our understanding of the success of the crab's camouflage by testing how quickly crabs are caught by predators with different visual systems, and how animals adapt to different environments. The experiment is now complete and we are no longer collecting data, but you can still play the game and explore the results." 230 420 1200 40)
      (set! ctx.font "normal 30pt open-sans")

      (set! ctx.globalAlpha 0.5)
      (ctx.drawImage (find-image "exeter.png") (- (- default-button-x 200) 123) 820)
      (ctx.drawImage (find-image "nhm-logo.png") (- default-button-x 80) 800)
      (ctx.drawImage (find-image "foam-logo.png") (- (+ default-button-x 200) 50) 790)
      (set! ctx.globalAlpha 1.0)
      

      )

    (game-modify-buttons
     (list
      (empty-image-button
       "Back"
       default-button-x
       (+ default-button-y 80)
       empty-button-width empty-button-height "none"
       (lambda (c)
         (bubbles-hit! 0 c)
         (button-sound)
         (nightjar-intro game))
       c)

      ;; (empty-image-button
      ;;  "Play!"
      ;;  default-button-x
      ;;  default-button-y
      ;;  empty-button-width empty-button-height
      ;;  "none"
      ;;  (lambda (c)
      ;;    (bubbles-hit! 1 c)
      ;;    (button-sound)
      ;;    (nightjar-experiment-screen c)))

      )
     c))))


(define (time-to-seconds t)
  (/ (Math.floor (/ t 10)) 100))

(define (nightjar-hiscores table ret-to-intro c)
  (update-bubble-pos
   (game-modify-update
   (lambda (t c) c)
   (game-modify-render
    (lambda (ctx)
      (draw-weed ctx c)
      (particle-system-render ctx (nightjar-bubbles (game-data c)))
      (set! ctx.font "normal 50pt open-sans")
      (wrap-text ctx (string-append "Hall of fame") 0 100 1000 70)
      (set! ctx.font "normal 30pt open-sans")

      (wrap-text ctx "Human" -200 180)
      (wrap-text ctx "Pollock" 200 180)

      (when (list-ref table 0)
            (index-for-each
             (lambda (i e)
               (let ((txt (string-append (car e) " : " (time-to-seconds (cadr e)))))
                 (wrap-text ctx txt -200 (+ 240 (* 40 i)))))
             (list-ref table 0)))

      (when (list-ref table 1)
            (index-for-each
             (lambda (i e)
               (let ((txt (string-append (car e) " : " (time-to-seconds (cadr e)))))
                 (wrap-text ctx txt 200 (+ 240 (* 40 i)))))
             (list-ref table 1)))
      )
    (game-modify-buttons
     (list
      (empty-image-button
       "Back" 1300 720 empty-button-width empty-button-height "none"
       (lambda (c)
         (bubbles-hit! 0 c)
         (button-sound)
         (if ret-to-intro
             (nightjar-intro c)
             (begin
               (server-call-mutate
                "stats" ()
                (lambda (game data)
                  (button-sound)
                  (nightjar-main-screen game (JSON.parse data))))
               c)))))
     c)))))


(define (nightjar-experiment-screen c)
  (update-bubble-pos
  (game-modify-render
   (lambda (ctx)
     (draw-weed ctx c)
     (particle-system-render ctx (nightjar-bubbles (game-data c)))
     (set! ctx.font "normal 50pt open-sans")
     (wrap-text ctx "We would like to use results from your game for a scientific publication, is that ok?" 0 200 1200 75)
     (set! ctx.font "normal 30pt open-sans")
     (wrap-text ctx "We are using age and timing information" 0 500 1000 75))

   (game-modify-buttons
    (list

     (empty-image-button
      "Yes that's fine"
      (+ default-button-x button-gap)
      default-button-y
      empty-button-width empty-button-height
      "none"
      (lambda (c)
        (bubbles-hit! 0 c)
        (button-sound)
        (nightjar-age-screen c)))

     (empty-image-button
      "No, go back"
      (- default-button-x button-gap)
      default-button-y
      empty-button-width empty-button-height
      "none"
      (lambda (c)
        (bubbles-hit! 1 c)
        (button-sound)
        (nightjar-intro c))))
    c))))

(define (nightjar-age-screen c)
  (update-bubble-pos
  (game-modify-render
   (lambda (ctx)
     (draw-weed ctx c)
     (particle-system-render ctx (nightjar-bubbles (game-data c)))
     (nightjar-all-text-lower ctx "What is your age?")
     (set! ctx.font "normal 30pt open-sans"))
   (game-modify-buttons
    (let ((age-but
           (lambda (title id)
             (empty-image-button
              title
              (+ (- default-button-x 850) (* id 280))
              default-button-y
              empty-button-width empty-button-height
              "none"
              (lambda (c)
                (button-sound)
                (bubbles-hit! (- id 1) c)
                (game-modify-data
                 (lambda (d)
                   (nightjar-modify-player-age
                    id d))
                 (nightjar-played-before-screen c)))))))

      (list
       (age-but "Under 10" 1)
       (age-but "10 to 15" 2)
       (age-but "16 to 35" 3)
       (age-but "36 to 50" 4)
       (age-but "Over 50" 5))
     )
    c))))

(define (record-player c played-before)
  (server-call-mutate
   "player"
   (list
    (list "played_before" played-before)
    (list "age_range" (nightjar-player-age (game-data c))))
   (lambda (game data)
     (let ((id (car (JSON.parse data))))
       (nightjar-species-screen
        (game-modify-data
         (lambda (d)
           (nightjar-modify-player-id
            id (nightjar-modify-played-before played-before d)))
         game)))))
  c)

(define (nightjar-played-before-screen c)
  (update-bubble-pos
  (game-modify-render
   (lambda (ctx)
     (draw-weed ctx c)
     (particle-system-render ctx (nightjar-bubbles (game-data c)))
     (nightjar-all-text-lower ctx "Have you played this game before?")
     (set! ctx.font "normal 30pt open-sans"))
   (game-modify-buttons
    (list

     (empty-image-button
      "Yes"
      (+ default-button-x button-gap)
      default-button-y
      empty-button-width empty-button-height
      "none"
      (lambda (c)
        (button-sound)
        (bubbles-hit! 0 c)
        (record-player c #t)))

     (empty-image-button
      "No"
      (- default-button-x button-gap)
      default-button-y
      empty-button-width empty-button-height
      "none"
      (lambda (c)
        (button-sound)
        (bubbles-hit! 1 c)
        (record-player c #f)))) c))))


(define (nightjar-species-screen c)
  (update-bubble-pos
  (game-modify-render
   (lambda (ctx)
     (draw-weed ctx c)
     (particle-system-render ctx (nightjar-bubbles (game-data c)))
     (set! ctx.font "normal 50pt open-sans")
     (wrap-text ctx "Will you hunt as a predatory pollock or a hungry human?" 0 150 1000 75)

     (set! ctx.font "normal 30pt open-sans")
     (wrap-text ctx "They see the world differently..." 0 310 1000 75)

     (centre-text2 ctx "Trichromatic vision"
                   (- default-button-x button-gap 100)
                   (- default-button-y 250))
     (centre-text2 ctx "Dichromatic vision"
                   (+ default-button-x button-gap 100)
                   (- default-button-y 250))

     (centre-text2 ctx "Human"
                   (- default-button-x button-gap 100)
                   (+ default-button-y 160))
     (set! ctx.font "normal 20pt open-sans")
     (centre-text2 ctx "Sees red, green and blue"
                   (- default-button-x button-gap 100)
                   (+ default-button-y 200))

     (set! ctx.font "normal 30pt open-sans")
     (centre-text2 ctx "Pollock"
                   (+ default-button-x button-gap 100)
                   (+ default-button-y 160))
     (set! ctx.font "normal 20pt open-sans")
     (centre-text2 ctx "Sees yellow and blue"
                   (+ default-button-x button-gap 100)
                   (+ default-button-y 200))

     )

   (game-modify-buttons
    (list

     (image-button
      ""
      (- default-button-x button-gap 100)
      (- default-button-y 50)
      "rotate"
      (find-image "human.png")
      (lambda (c)
        (button-sound)
        (nightjar-explain-screen
         (game-modify-data
          (lambda (d)
            (nightjar-modify-player-type "human" d))
          c))))

     (rect-button
      ""
      (- default-button-x button-gap 310)
      (+ default-button-y 20) 500 300
      "none"
      (lambda (c)
        (button-sound)
        (bubbles-hit! 0 c)
        (nightjar-explain-screen
         (game-modify-data
          (lambda (d)
            (nightjar-modify-player-type "human" d))
          c))))


     (image-button
      ""
      (+ default-button-x button-gap 100)
      (- default-button-y 50)
      "rotate"
      (find-image "pollock.png")
      (lambda (c)
        (button-sound)
        (nightjar-explain-screen
         (game-modify-data
          (lambda (d)
            (nightjar-modify-player-type "pollock" d))
          c))))

     (rect-button
      ""
      (+ default-button-x 150)
      (+ default-button-y 20) 500 300
      "none"
      (lambda (c)
        (bubbles-hit! 1 c)
        (button-sound)
        (nightjar-explain-screen
         (game-modify-data
          (lambda (d)
            (nightjar-modify-player-type "pollock" d))
          c))))



    ) c))))

(define (nightjar-main-screen c data)
  (update-bubble-pos
   (game-modify-render
    (lambda (ctx)
      (draw-weed ctx c)
      (particle-system-render ctx (nightjar-bubbles (game-data c)))
      (set! ctx.font "normal 50pt open-sans")
      (wrap-text ctx "Eden Project experiment results" 0 120 1400 70)
      ;;(set! ctx.font "normal 20pt open-sans")
      ;;(wrap-text ctx "Researchers will use these results to support their theories on the effectiveness of crab camouflage in different natural habitats" 0 130 1000 35)
      (set! ctx.font "normal 30pt open-sans")

      (set! ctx.globalAlpha 0.2)
      (set! ctx.fillStyle "#99d5cd")
      (roundRect ctx 400 170 800 650 20 #t #f)
      (set! ctx.fillStyle "#fff")
      (set! ctx.globalAlpha 1)


      (cond
       ((eq? (nightjar-results-num (game-data c)) 0)
        (render-results-3 ctx data 250))
       ((eq? (nightjar-results-num (game-data c)) 1)
        (render-results-2 ctx data 250))
       (else
        (render-results-1 ctx data 250))))


    (game-modify-buttons
     (list

            (image-button
       "" 300 440
       "rotate"
       (find-image "left-arrow.png")
       (lambda (c)
         (button-sound)
         (game-modify-data
          (lambda (d)
            (nightjar-modify-results-num
             (modulo (- (nightjar-results-num d) 1) 3) d))
          c)))

      (image-button
       "" (- screen-width 300) 440
       "rotate"
       (find-image "right-arrow.png")
       (lambda (c)
         (button-sound)
         (game-modify-data
          (lambda (d)
            (nightjar-modify-results-num
             (modulo (+ (nightjar-results-num d) 1) 3) d))
          c)))

     (empty-image-button
      "Play again" (- screen-width 200)
      820 empty-button-width empty-button-height "none"
      (lambda (c)
        (bubbles-hit! 0 c)
        (button-sound)
        (nightjar-species-screen c)))


     (empty-image-button
      "Exit game" 200
      820 empty-button-width empty-button-height "none"
      (lambda (c)
        (bubbles-hit! 1 c)
        (button-sound)
        (nightjar-intro c)))

      )
     c))))


(define (get-n-items lst num)
  (cond
   ((null? lst) ())
   ((zero? num) ())
   (else (cons (car lst) (get-n-items (cdr lst) (- num 1))))))

(define (slice lst start count)
  (if (> start 1)
      (slice (cdr lst) (- start 1) count)
      (get-n-items lst count)))

(define (record-game c)
  (server-call-mutate
   "game"
   (list
    (list "player_id" (nightjar-player-id (game-data c)))
    (list "species" (nightjar-player-type (game-data c))))
   (lambda (game data)
     (let ((id (car (JSON.parse data))))
       (nightjar-new-game-images
        (game-modify-data
         (lambda (d)
           (nightjar-modify-game-id id d))
         game)))))
  c)

(define (nightjar-explain-screen c)
  (update-bubble-pos
  (game-modify-render
   (lambda (ctx)
     (draw-weed ctx c)
     (ctx.drawImage (find-image "example-crab.jpg") 330 210)
     (particle-system-render ctx (nightjar-bubbles (game-data c)))
     (set! ctx.font "normal 30pt open-sans")
     (wrap-text ctx "There is one crab hidden in every photo, tap it as soon as you see it" 0 100 800 45))
   (game-modify-buttons
    (list

     (empty-image-button
      "Play!"
      default-button-x
      (+ default-button-y 130)
      empty-button-width empty-button-height
      "none"
      (lambda (c)
        (bubbles-hit! 0 c)
        (record-game c)))


     ;; (empty-image-button
     ;;  "Rock pool"
     ;;  (- default-button-x 400)
     ;;  (+ default-button-y 150)
     ;;  500 300
     ;;  "none"
     ;;  (lambda (c)
     ;;    (bubbles-hit! 0 c)
     ;;    (record-game c "rockpool")))

     ;; (empty-image-button
     ;;  "Mudflats"
     ;;  default-button-x
     ;;  (+ default-button-y 150)
     ;;  500 300
     ;;  "none"
     ;;  (lambda (c)
     ;;    (bubbles-hit! 1 c)
     ;;    (record-game c "mudflat")))

     ;; (empty-image-button
     ;;  "Mussel bed"
     ;;  (+ default-button-x 400)
     ;;  (+ default-button-y 150)
     ;;  500 300
     ;;  "none"
     ;;  (lambda (c)
     ;;    (bubbles-hit! 2 c)
     ;;    (record-game c "musselbed")))
     ) c))))

(define (prep-path p)
  (p.replace (js "new RegExp('/', 'g')") ":"))

(define (record-click c success)
  (let ((photo (car (nightjar-images (game-data c))))
        (crab (car (nightjar-crabs (game-data c)))))
    (let ((photo-habitat (photo-habitat photo))
          (crab-habitat (photo-habitat crab))
          (photoname (photo-filename photo))
          (crabname (photo-filename crab)))
      (server-call
       "click"
       (list
        (list "game_id" (nightjar-game-id (game-data c)))
        (list "photo_name" (prep-path photoname))
        (list "crab_name" (prep-path crabname))
        (list "photo_habitat" photo-habitat)
        (list "crab_habitat" crab-habitat)
        (list "crab_x" (car (nightjar-crab-pos (game-data c))))
        (list "crab_y" (cadr (nightjar-crab-pos (game-data c))))
        (list "crab_rot" (nightjar-crab-rotation (game-data c)))
        (list "time_stamp" (- (game-time c) (nightjar-photo-time (game-data c))))
        (list "x_position" (game-mx c))
        (list "y_position" (game-my c))
        (list "success" success))))))

(define (record-crab-time c success_code)
  (let ((photo (car (nightjar-images (game-data c))))
        (crab (car (nightjar-crabs (game-data c)))))
    (let ((photo-habitat (photo-habitat photo))
          (crab-habitat (photo-habitat crab))
          (photoname (photo-filename photo))
          (crabname (photo-filename crab)))
      (server-call
       "crab-time"
       (list
        (list "game_id" (nightjar-game-id (game-data c)))
        (list "photo_name" (prep-path photoname))
        (list "crab_name" (prep-path crabname))
        (list "photo_habitat" photo-habitat)
        (list "crab_habitat" crab-habitat)
        (list "time_stamp" (- (game-time c) (nightjar-photo-time (game-data c))))
        (list "success_code" success_code))))))

(define (draw-crab ctx crab-image crab-x crab-y crab-rot)
  (ctx.save)
  (ctx.translate crab-x crab-y)
  (ctx.translate (/ crab-image.width 2) (/ crab-image.height 2))
  (ctx.rotate crab-rot)
  (ctx.translate (- 0 (/ crab-image.width 2))
                 (- 0 (/ crab-image.height 2)))
  (ctx.drawImage crab-image 0 0)
  (ctx.restore))

(define (nightjar-game c)
  ;; todo: choose and delete

  (define example (car (nightjar-images (game-data c))))
  (define crab (car (nightjar-crabs (game-data c))))
  (define crab-image (find-image (photo-filename crab)))
  (define crab-x (- (car (nightjar-crab-pos (game-data c)))
                    (/ crab-image.width 2)))
  (define crab-y (- (cadr (nightjar-crab-pos (game-data c)))
                    (/ crab-image.height 2)))

  (game-modify-render
   (lambda (ctx)
     (ctx.drawImage
      (find-image (photo-filename example)) 0 0)

     (draw-crab
      ctx crab-image crab-x crab-y
      (nightjar-crab-rotation (game-data c)))

     (sprite-render
      ctx
      (game-time c)
      (nightjar-sprite (game-data c)))

     (nightjar-draw-clock
      ctx (/ (- (game-time c)
                (nightjar-start-time (game-data c)))
             1000) game-time-allowed))

   (game-modify-update
    (lambda (t c)
      (if (> (- (game-time c)
                (nightjar-start-time (game-data c)))
             (* game-time-allowed 1000))
          (begin
            (record-crab-time c 1)
            (nightjar-fail
             (photo-desc example)
             "" c))
          c))

    (game-modify-buttons
     (list

      ;; (image-button
      ;;  "I give up"
      ;;  (- screen-width 100)
      ;;  (- screen-height 100)
      ;;  #f
      ;;  (find-image "quit.png")
      ;;  (lambda (c)
      ;;    (record-crab-time c 2)
      ;;    (nightjar-fail
      ;;     (photo-desc example)
      ;;     (string-append
      ;;      "You couldn't find this crab on "
      ;;      (photo-desc example)
      ;;      " - you'll go hungry tonight!")
      ;;     c)))

      ;; button over nightjar
      (rect-button
       "" crab-x crab-y crab-image.width crab-image.height #f
       (lambda (c)
         (play-sound "found.wav")
         (record-crab-time c 0)
         (nightjar-win
          (photo-desc example)
          (game-modify-data
           (lambda (d)
             (record-click c 1)
             (nightjar-modify-sprite
              (sprite (- (game-mx c) 88)
                      (- (game-my c) 88)
                      "right.png" (+ (game-time c) 2000))
              (nightjar-modify-score
               (- (game-time c) (nightjar-start-time d)) d)))
           c))))

      ;; big lose button over whole screen
      (rect-button
       ""
       0 0 screen-width screen-height #f
       (lambda (c)
         (play-sound "notfound.wav")
         (game-modify-data
          (lambda (d)
            (record-click c 0)
            (nightjar-modify-sprite
             (sprite (- (game-mx c) 88)
                     (- (game-my c) 88)
                     "wrong.png" (+ (game-time c) 2000)) d))
          c)))

      ) c))))

(define (nightjar-fail desc reason c)
  (set! bubbles (bubbles-reset bubbles))
  (define example (car (nightjar-images (game-data c))))
  (define crab (car (nightjar-crabs (game-data c))))
  (define crab-image (find-image (photo-filename crab)))
  (define crab-x (- (car (nightjar-crab-pos (game-data c)))
                    (/ crab-image.width 2)))
  (define crab-y (- (cadr (nightjar-crab-pos (game-data c)))
                    (/ crab-image.height 2)))

  (update-bubble-pos
  (game-modify-render
   (lambda (ctx)
     (ctx.drawImage
      (find-image (photo-filename example))
      0 0)

     (draw-crab
      ctx crab-image crab-x crab-y
      (nightjar-crab-rotation (game-data c)))

     ;; highlight the crab
     (set! ctx.strokeStyle "#99d5cd")
     (ctx.setLineDash (list 20 20))
     (set! ctx.lineWidth 10)
     (ctx.beginPath)
     (ctx.arc (car (nightjar-crab-pos (game-data c)))
              (cadr (nightjar-crab-pos (game-data c)))
              (/ crab-image.width 2) 0 (* Math.PI 2) true)
     (ctx.closePath)
     (ctx.stroke)
     (set! ctx.lineWidth 1)

     (particle-system-render ctx (nightjar-bubbles (game-data c)))

     (sprite-render
      ctx
      (game-time c)
      (nightjar-sprite (game-data c)))

     (let ((left (- 20 (+ (- 20 (length (nightjar-images (game-data c)))) 1))))
       (set! ctx.font "normal 50pt open-sans")
       (wrap-text ctx (string-append
                       "Ran out of time finding this crab - you'll go hungry tonight!") 0 200 1300 75)
       (set! ctx.font "normal 40pt open-sans")
       (wrap-text ctx (string-append "Crab from: " (photo-desc crab)) 0 400 1000 75)
       (wrap-text ctx (string-append "Background: " (photo-desc example)) 0 500 1000 75)
       (wrap-text ctx (string-append
                       (if (eq? left 1)
                           (string-append left " crab")
                           (string-append left " crabs"))
                       " left to go!") 0 600 1000 75))

     (set! ctx.font "normal 30pt open-sans"))

   (game-modify-update
    (lambda (t c) c)

    (game-modify-buttons
     (list

      (empty-image-button
       "Next crab"
       default-button-x
       (+ default-button-y 100)
       empty-button-width empty-button-height
       "none"
       (lambda (c)
        (bubbles-hit! 0 c)
         (button-sound)
         ;; check end of game
         (if (eq? (length (nightjar-images (game-data c))) 1)
             (nightjar-get-score c "Well done!")
             (nightjar-new-game-reset-timer c))))

      ;; (empty-image-button
      ;;  "Quit"
      ;;  (- default-button-x button-gap)
      ;;  default-button-y
      ;;  empty-button-width empty-button-height
      ;;  "none"
      ;;  (lambda (c)
      ;;    (bubbles-hit! 1 c)
      ;;    (button-sound)
      ;;    ;; check end of game
      ;;    (nightjar-get-score c "Thank you for playing.")))


      ) c)))))

(define (nightjar-win desc c)
  (set! bubbles (bubbles-reset bubbles))
  (define example (car (nightjar-images (game-data c))))
  (define crab (car (nightjar-crabs (game-data c))))
  (define crab-image (find-image (photo-filename crab)))
  (define crab-x (- (car (nightjar-crab-pos (game-data c)))
                    (/ crab-image.width 2)))
  (define crab-y (- (cadr (nightjar-crab-pos (game-data c)))
                    (/ crab-image.height 2)))

  (update-bubble-pos
  (game-modify-render
   (lambda (ctx)
     (ctx.drawImage
      (find-image (photo-filename example) image-lib)
      0 0)

     (draw-crab
      ctx crab-image crab-x crab-y
      (nightjar-crab-rotation (game-data c)))

     (particle-system-render ctx (nightjar-bubbles (game-data c)))

     (sprite-render
      ctx
      (game-time c)
      (nightjar-sprite (game-data c)))

     (let ((left (- 20 (+ (- 20 (length (nightjar-images (game-data c)))) 1))))
       (set! ctx.font "normal 50pt open-sans")
       (wrap-text ctx (string-append
                       "You caught this crab in " (/ (nightjar-score (game-data c)) 1000)
                       " seconds. ") 0 200 1000 75)
       (set! ctx.font "normal 40pt open-sans")
       (wrap-text ctx (string-append "Crab from: " (photo-desc crab)) 0 400 1000 75)
       (wrap-text ctx (string-append "Background: " (photo-desc example)) 0 500 1000 75)
       (wrap-text ctx (string-append
                       (if (eq? left 1)
                           (string-append left " crab")
                           (string-append left " crabs"))
                       " left to go!") 0 600 1000 75))

     (set! ctx.font "normal 30pt open-sans"))

   (game-modify-update
    (lambda (t c) c)

    (game-modify-buttons
     (list
      (empty-image-button
       "Next crab"
       default-button-x
       (+ default-button-y 100)
       empty-button-width empty-button-height
       "none"
       (lambda (c)
         (button-sound)
        (bubbles-hit! 0 c)
         ;; check end of game
         (if (eq? (length (nightjar-images (game-data c))) 1)
             (nightjar-get-score c "Well done!")
             (nightjar-new-game-reset-timer c))))
      ) c)))))

(define (nightjar-get-score c reason)
  (server-call-mutate
   "score"
   (list
    (list "game_id" (nightjar-game-id (game-data c))))
   (lambda (game data)
     (let ((score (JSON.parse data)))
       (nightjar-finish game
                        (list-ref score 0)
                        (list-ref score 1)
                        (list-ref score 2)
                        reason))))
  c)

(define (score-to-text score)
  (cond
   ((eq? score 1) "1st")
   ((eq? score 2) "2nd")
   ((eq? score 3) "3rd")
   (else (+ score "th"))))

(define (get-score-text score count)
  (if (> count 5)
      (+ " You made position " score " out of all the people who've played so far!")
      "Find more crabs to get a ranking"))

(define (trunc a)
  (/ (Math.floor (* a 100)) 100))

(define (nightjar-finish c av score count reason)
  (set! bubbles (bubbles-reset bubbles))
  (update-bubble-pos
  (game-modify-render
   (lambda (ctx)
     (draw-weed ctx c)
     (particle-system-render ctx (nightjar-bubbles (game-data c)))
     (nightjar-all-text
      ctx (+ reason " Your average crab spotting time is " (trunc (/ av 1000)) " seconds."))

     (wrap-text ctx (get-score-text score count) 0 430 800 55)
     )

   (game-modify-update
    (lambda (t c) c)

    (game-modify-buttons
     (list
      (if (and #f
               (eq? (nightjar-username (game-data c)) "???")
               (> count 5))
          (empty-image-button
           "Enter Your Name"
           default-button-x
           default-button-y
           empty-button-width empty-button-height
           "none"
           (lambda (c)
             (bubbles-hit! 0 c)
             (button-sound)
             (nightjar-enter-name c)))

          (empty-image-button
           "Continue"
           default-button-x
           default-button-y
           empty-button-width empty-button-height
           "none"
           (lambda (c)
             (bubbles-hit! 0 c)
             (button-sound)
             (server-call-mutate
              "stats" ()
              (lambda (game data)
                (button-sound)
                (nightjar-main-screen game (JSON.parse data))))
             c))))
     c)))))


(define (type-into str ch)
  (car
   (foldl
    (lambda (c r)
      (if (and (not (cadr r)) (eq? c "?"))
          (list (string-append (car r) ch) #t)
          (list (string-append (car r) c) (cadr r))))
    (list "" #f)
    (str.split ""))))

(define (type-into-delete str)
  (car (foldl
        (lambda (c r)
          ;;(console.log (list c r))
          (if (and (not (cadr r)) (not (eq? c "?")))
              (list (string-append "?" (car r)) #t)
              (list (string-append c (car r)) (cadr r))))
        (list "" #f)
        (reverse (str.split "")))))

(define (type-username ch c)
  (game-modify-data
   (lambda (d)
     (nightjar-modify-username (dbg (type-into (dbg (nightjar-username d)) ch)) d))
   c))

(define (type-delete c)
  (game-modify-data
   (lambda (d)
     (nightjar-modify-username (type-into-delete (nightjar-username d)) d))
   c))

(define (nightjar-enter-name c)
  (update-bubble-pos
  (game-modify-update
   (lambda (t c) c)
   (game-modify-render
    (lambda (ctx)
      (draw-weed ctx c)
      (particle-system-render ctx (nightjar-bubbles (game-data c)))
      (set! ctx.font "normal 30pt open-sans")
      (wrap-text ctx "Enter your name" 0 200 1000 70)
      (set! ctx.font "normal 50pt open-sans")
      (wrap-text ctx (nightjar-username (game-data c)) 0 280 1000 70)
      (set! ctx.font "normal 30pt open-sans"))

    (game-modify-buttons
     (append
      (index-map
       (lambda (i ch)
         (let ((x (+ 100 (* (modulo i 10) 120)))
               (y (+ 400 (* (Math.floor (/ i 10)) 130))))
           (image-button ch x y #f (small-button-image)
                         (lambda (c)
                           (button-sound)
                           (type-username ch c)))))
       (list "A" "B" "C" "D" "E" "F" "G" "H" "I" "J" "K" "L" "M"
             "N" "O" "P" "Q" "R" "S" "T" "U" "V" "W" "X" "Y" "Z"))

      (list
       (empty-image-button "Delete" 1200 700 empty-button-width empty-button-height #t
                           (lambda (c)
                             (button-sound)
                             (bubbles-hit! 0 c)
                             (type-delete c)))

       (empty-image-button "Done" 1450 700 empty-button-width empty-button-height "none"
                     (lambda (c)
                       (bubbles-hit! 1 c)
                       (button-sound)
                       (server-call
                        "player-name"
                        (list
                         (list "player_id" (nightjar-player-id (game-data c)))
                         (list "player_name" (nightjar-username (game-data c)))))
                       (server-call-mutate
                        "stats" ()
                        (lambda (game data)
                          (button-sound)
                          (nightjar-main-screen game (JSON.parse data))))
                       c)))
      )
     c)))))



(define (nightjar-results c data)
  (update-bubble-pos
   (game-modify-render
    (lambda (ctx)
      (draw-weed ctx c)
      (particle-system-render ctx (nightjar-bubbles (game-data c)))
      (set! ctx.font "normal 50pt open-sans")
      (wrap-text ctx "Live experiment results" 0 80 1000 70)
      (set! ctx.font "normal 20pt open-sans")
      (wrap-text ctx "Researchers will use these results to support their theories on the effectiveness of crab camouflage in different natural habitats" 0 130 1000 35)
      (set! ctx.font "normal 30pt open-sans")

      (set! ctx.globalAlpha 0.2)
      (set! ctx.fillStyle "#99d5cd")
      (roundRect ctx 400 210 800 650 20 #t #f)
      (set! ctx.fillStyle "#fff")
      (set! ctx.globalAlpha 1)


      (cond
       ((eq? (nightjar-results-num (game-data c)) 0)
        (render-results-3 ctx data 290))
       ((eq? (nightjar-results-num (game-data c)) 1)
        (render-results-2 ctx data 290))
       (else
        (render-results-1 ctx data 290))))


    (game-modify-buttons
     (list
      (image-button
       "" 300 480
       "rotate-fast"
       (find-image "left-arrow.png")
       (lambda (c)
         (button-sound)
         (game-modify-data
          (lambda (d)
            (nightjar-modify-results-num
             (modulo (- (nightjar-results-num d) 1) 3) d))
          c)))

      (image-button
       "" (- screen-width 300) 480
       "rotate-fast"
       (find-image "right-arrow.png")
       (lambda (c)
         (button-sound)
         (game-modify-data
          (lambda (d)
            (nightjar-modify-results-num
             (modulo (+ (nightjar-results-num d) 1) 3) d))
          c)))

      (empty-image-button
       "Back"
       (- screen-width 200)
       (+ default-button-y 150)
       empty-button-width empty-button-height "none"
       (lambda (c)
         (bubbles-hit! 0 c)
         (button-sound)
         (nightjar-intro c)))
      )
     c))))





(set! ctx.font "normal 75pt open-sans")
(centre-text ctx "Loading..." 240)

(load-sounds!
 (list
  "found.wav"
  "notfound.wav"
  "bubble-1.wav"
  "bubble-2.wav"
  "bubble-3.wav"
  "bubble-7.wav"
  ))


(load-images!
 (list "button-1.png"
       "button-2.png"
       "button-3.png"
       "button-s1.png"
       "quit.png"
       "right.png"
       "wrong.png"
       "foam.png"
       "sensory-ecology.png"
       "example-crab.jpg"
       "cutoutweed.png"
       "cutoutweed2.png"
       "cutoutweed3.png"
       "cutoutweed4.png"
       "cutoutweed5.png"
       "cutoutweed6.png"
       "cutoutweed7.png"
       "cutoutweed8.png"
       "human.png"
       "pollock.png"
       "bubble-1.png"
       "bubble-2.png"
       "bubble-3.png"
       "bubble-4.png"
       "bubble-5.png"
       "bubble-6.png"
       "bubble-7.png"
       "bubble-8.png"
       "bubble-9.png"
       "crab1.png"
       "crab2.png"
       "nhm-logo.png"
       "foam-logo.png"
       "exeter.png"
       "rockpool-crab.png"
       "mudflat-crab.png"
       "musselbed-crab.png"
       "starfish.png"
       "left-arrow.png"
       "right-arrow.png"
       )
 (lambda ()
   (set! bubbles (build-bubbles))
   (start-game canvas ctx)))
